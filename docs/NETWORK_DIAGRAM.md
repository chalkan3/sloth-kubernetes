# Network Architecture Diagram

## Complete Network Topology

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                          Internet / Public Network                           │
└────────────────────────────┬────────────────────────────────────────────────┘
                             │
                             │
        ┌────────────────────┼────────────────────┐
        │                    │                    │
        │                    │                    │
   ┌────▼────┐          ┌────▼────┐         ┌────▼────┐
   │   DO    │          │ Linode  │         │   AWS   │
   │  Nodes  │          │  Nodes  │         │   VPN   │
   │         │          │         │         │  Server │
   └────┬────┘          └────┬────┘         └────┬────┘
        │                    │                    │
        │                    │                    │
        │   WireGuard VPN Mesh (10.8.0.0/24)    │
        │                    │                    │
        └────────────────────┼────────────────────┘
                             │
    ┌────────────────────────┴────────────────────────┐
    │                                                  │
┌───▼───────────────────────────────────────────────────▼────┐
│               WireGuard VPN Network (10.8.0.0/24)           │
│                                                              │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐   │
│  │VPN Server│  │  Client  │  │ Master 1 │  │ Master 2 │   │
│  │10.8.0.1  │  │10.8.0.2  │  │10.8.0.10 │  │10.8.0.11 │   │
│  └──────────┘  └──────────┘  └──────────┘  └──────────┘   │
│                                                              │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐   │
│  │ Master 3 │  │ Worker 1 │  │ Worker 2 │  │ Worker 3 │   │
│  │10.8.0.12 │  │10.8.0.13 │  │10.8.0.14 │  │10.8.0.15 │   │
│  └──────────┘  └──────────┘  └──────────┘  └──────────┘   │
│                                                              │
└──────────────────────────────────────────────────────────────┘
```

## Kubernetes Cluster Network Detail

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                          Kubernetes Cluster                                  │
│                                                                               │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                      Control Plane (HA)                              │   │
│  │                                                                       │   │
│  │  ┌──────────────────┐  ┌──────────────────┐  ┌──────────────────┐  │   │
│  │  │    master-1      │  │    master-2      │  │    master-3      │  │   │
│  │  │   10.8.0.10      │  │   10.8.0.11      │  │   10.8.0.12      │  │   │
│  │  │                  │  │                  │  │                  │  │   │
│  │  │ ┌──────────────┐ │  │ ┌──────────────┐ │  │ ┌──────────────┐ │  │   │
│  │  │ │ API Server   │ │  │ │ API Server   │ │  │ │ API Server   │ │  │   │
│  │  │ │ :6443        │ │  │ │ :6443        │ │  │ │ :6443        │ │  │   │
│  │  │ └──────────────┘ │  │ └──────────────┘ │  │ └──────────────┘ │  │   │
│  │  │ ┌──────────────┐ │  │ ┌──────────────┐ │  │ ┌──────────────┐ │  │   │
│  │  │ │ etcd         │◄┼──┼─┤ etcd         │◄┼──┼─┤ etcd         │ │  │   │
│  │  │ │ :2379,2380   │ │  │ │ :2379,2380   │ │  │ │ :2379,2380   │ │  │   │
│  │  │ └──────────────┘ │  │ └──────────────┘ │  │ └──────────────┘ │  │   │
│  │  │ ┌──────────────┐ │  │ ┌──────────────┐ │  │ ┌──────────────┐ │  │   │
│  │  │ │ Scheduler    │ │  │ │ Scheduler    │ │  │ │ Scheduler    │ │  │   │
│  │  │ └──────────────┘ │  │ └──────────────┘ │  │ └──────────────┘ │  │   │
│  │  │ ┌──────────────┐ │  │ ┌──────────────┐ │  │ ┌──────────────┐ │  │   │
│  │  │ │Controller Mgr│ │  │ │Controller Mgr│ │  │ │Controller Mgr│ │  │   │
│  │  │ └──────────────┘ │  │ └──────────────┘ │  │ └──────────────┘ │  │   │
│  │  └──────────────────┘  └──────────────────┘  └──────────────────┘  │   │
│  └───────────────────────────────────┬───────────────────────────────────┘   │
│                                      │                                        │
│                                      │ Calico CNI                             │
│                                      │                                        │
│  ┌───────────────────────────────────┴───────────────────────────────────┐   │
│  │                         Worker Nodes                                   │   │
│  │                                                                         │   │
│  │  ┌──────────────────┐  ┌──────────────────┐  ┌──────────────────┐    │   │
│  │  │    worker-1      │  │    worker-2      │  │    worker-3      │    │   │
│  │  │   10.8.0.13      │  │   10.8.0.14      │  │   10.8.0.15      │    │   │
│  │  │   (tools)        │  │   (tools)        │  │   (misc)         │    │   │
│  │  │                  │  │                  │  │                  │    │   │
│  │  │ ┌──────────────┐ │  │ ┌──────────────┐ │  │ ┌──────────────┐ │    │   │
│  │  │ │   kubelet    │ │  │ │   kubelet    │ │  │ │   kubelet    │ │    │   │
│  │  │ └──────────────┘ │  │ └──────────────┘ │  │ └──────────────┘ │    │   │
│  │  │ ┌──────────────┐ │  │ ┌──────────────┐ │  │ ┌──────────────┐ │    │   │
│  │  │ │ containerd   │ │  │ │ containerd   │ │  │ │ containerd   │ │    │   │
│  │  │ └──────────────┘ │  │ └──────────────┘ │  │ └──────────────┘ │    │   │
│  │  │ ┌──────────────┐ │  │ ┌──────────────┐ │  │ ┌──────────────┐ │    │   │
│  │  │ │Nginx Ingress │ │  │ │Nginx Ingress │ │  │ │Nginx Ingress │ │    │   │
│  │  │ │   :80,:443   │ │  │ │   :80,:443   │ │  │ │   :80,:443   │ │    │   │
│  │  │ └──────────────┘ │  │ └──────────────┘ │  │ └──────────────┘ │    │   │
│  │  │                  │  │                  │  │                  │    │   │
│  │  │  [Pods: Tools]   │  │  [Pods: Tools]   │  │  [Pods: Misc]    │    │   │
│  │  └──────────────────┘  └──────────────────┘  └──────────────────┘    │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                               │
└───────────────────────────────────────────────────────────────────────────────┘
```

## Traffic Flow Diagram

### External User → ArgoCD (via VPN)

```
┌──────────────┐
│              │
│  Your Client │
│  (10.8.0.2)  │
│              │
└──────┬───────┘
       │ 1. VPN connection via WireGuard
       │
       ▼
┌──────────────┐
│              │
│  VPN Server  │
│  (10.8.0.1)  │
│              │
└──────┬───────┘
       │ 2. Route to K8s worker
       │
       ▼
┌──────────────────────────────────────┐
│  worker-1 (10.8.0.13)                │
│                                       │
│  ┌────────────────────────────────┐  │
│  │  Nginx Ingress Controller      │  │
│  │  Listening on :443 (hostPort)  │  │
│  └────────────┬───────────────────┘  │
│               │ 3. Route based on    │
│               │    Host header       │
│               ▼                      │
│  ┌────────────────────────────────┐  │
│  │  Ingress Resource              │  │
│  │  Host: argocd.kube.*           │  │
│  └────────────┬───────────────────┘  │
│               │ 4. Forward to        │
│               │    ClusterIP         │
│               ▼                      │
│  ┌────────────────────────────────┐  │
│  │  ArgoCD Service (ClusterIP)    │  │
│  │  Port: 443                     │  │
│  └────────────┬───────────────────┘  │
│               │ 5. Load balance      │
│               │    to pods           │
│               ▼                      │
│  ┌────────────────────────────────┐  │
│  │  ArgoCD Server Pods            │  │
│  │  Port: 8080                    │  │
│  └────────────────────────────────┘  │
│                                       │
└───────────────────────────────────────┘
```

### kubectl → Kubernetes API

```
┌──────────────┐
│              │
│  Your Client │
│  (10.8.0.2)  │
│              │
└──────┬───────┘
       │ 1. VPN connection
       │
       ▼
┌──────────────┐
│              │
│  VPN Server  │
│  (10.8.0.1)  │
│              │
└──────┬───────┘
       │ 2. Route to master
       │
       ▼
┌──────────────────────────────┐
│  master-1 (10.8.0.10)        │
│                               │
│  ┌────────────────────────┐  │
│  │  API Server            │  │
│  │  Port: 6443            │  │
│  │  (TLS encrypted)       │  │
│  └────────────────────────┘  │
│                               │
└───────────────────────────────┘
```

## WireGuard Peer Connections

### Full Mesh Topology

```
Each node connects to every other node:

master-1 (10.8.0.10) ──┬── VPN Server (10.8.0.1)
                       ├── master-2 (10.8.0.11)
                       ├── master-3 (10.8.0.12)
                       ├── worker-1 (10.8.0.13)
                       ├── worker-2 (10.8.0.14)
                       └── worker-3 (10.8.0.15)

master-2 (10.8.0.11) ──┬── VPN Server (10.8.0.1)
                       ├── master-1 (10.8.0.10)
                       ├── master-3 (10.8.0.12)
                       ├── worker-1 (10.8.0.13)
                       ├── worker-2 (10.8.0.14)
                       └── worker-3 (10.8.0.15)

... (similar for all nodes)

Total tunnels: 6 peers per Kubernetes node
```

### Network Latency

```
Your Client (10.8.0.2) → VPN Server (10.8.0.1)
    │
    ├─> master-1 (10.8.0.10)  ~140ms (via VPN gateway)
    ├─> worker-1 (10.8.0.13)  ~144ms (via VPN gateway)
    └─> worker-3 (10.8.0.15)  ~140ms (via VPN gateway)

master-1 (10.8.0.10) → master-2 (10.8.0.11)  ~7ms (direct tunnel)
master-1 (10.8.0.10) → worker-1 (10.8.0.13)  ~7ms (direct tunnel)
```

## DNS Resolution Flow

```
Client Request: https://argocd.kube.chalkan3.com.br

1. DNS Lookup
   └─> DigitalOcean DNS Server
       └─> Returns: 10.8.0.13 (VPN IP)

2. Route via VPN
   Your Client (10.8.0.2)
       └─> VPN Server (10.8.0.1)
           └─> worker-1 (10.8.0.13)

3. Nginx Ingress Controller (worker-1:443)
       └─> Checks Host header
           └─> Matches: argocd.kube.chalkan3.com.br

4. Forward to ClusterIP Service
       └─> argocd-server.argocd.svc.cluster.local:443

5. Load balance to Pod
       └─> ArgoCD Server Pod :8080
```

## Port Reference

| Node Type | Service          | Port  | Protocol | Access        |
|-----------|------------------|-------|----------|---------------|
| Master    | Kubernetes API   | 6443  | HTTPS    | VPN only      |
| Master    | etcd client      | 2379  | TCP      | Internal only |
| Master    | etcd peer        | 2380  | TCP      | Internal only |
| Master    | Kubelet          | 10250 | HTTPS    | Internal only |
| Worker    | Nginx Ingress    | 80    | HTTP     | VPN only      |
| Worker    | Nginx Ingress    | 443   | HTTPS    | VPN only      |
| Worker    | Kubelet          | 10250 | HTTPS    | Internal only |
| All       | WireGuard        | 51820 | UDP      | Public        |
| All       | Calico BGP       | 179   | TCP      | Internal only |
